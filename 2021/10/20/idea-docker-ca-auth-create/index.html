<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>Sneakydog-demo</title>
    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/font_859455_eaq7v6w8ktj.css">
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
    <header class="header">
    <div class="header-inner">
        <div class="header-title">

        </div>
        <nav class="header-nav">
            
            <a href="/" class="header-nav-link" >
                Home
            </a>
            

            
            <a href="/archives" class="header-nav-link">
                Archives
            </a>
            

            
            <a href="/tags" class="header-nav-link">
                Tags
            </a>
            

            
            <a href="/about/" class="header-nav-link">
                About
            </a>
            
        </nav>
    </div>
</header>
    <header class="mobile-header">
    <div class="mobile-nav">
        <div class="mobile-nav-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="mobile-nav-title">
            <a href="/" class="mobile-nav-title-link">Hxh's Blog</a>
        </div>

    </div>
    <nav class="mobile-menu">
        <ul class="mobile-menu-list">
            <li class="mobile-menu-item">
                <i class="iconfont icon-home"></i>
                <a href="/" class="mobile-nav-link">Home</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-archive"></i>
                <a href="/archives" class="mobile-nav-link">Archives</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-tag"></i>
                <a href="/tags" class="mobile-nav-link">Tags</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-about"></i>
                <a href="/about/" class="mobile-nav-link">About</a>
            </li>
        </ul>
    </nav>
</header>
    <div class="main">
        <div class="content-inner">
            <div class="posts">
    <article class="post-whole">
        <div class="post-title">
            <h2 class="title">在idea中一键部署项目到Docker及CA认证</h2>
            <div class="post-meta">
                <span class="post-time">2021-10-20</span>
                
                <span class="post-visit"> visited：<span id="busuanzi_value_page_pv"></span></span>
            </div>
        </div>
        <div class="post-toc" id="post-toc">
    <strong class="post-toc-title">目录</strong>
    <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BAca%E6%96%87%E4%BB%B6%E5%A4%B9%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95"><span class="toc-text">1.创建ca文件夹工作目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BA-CA-%E7%A7%81%E9%92%A5%E5%92%8C%E5%85%AC%E9%92%A5"><span class="toc-text">2.创建 CA 私钥和公钥</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AF%86%E7%A0%81"><span class="toc-text">创建密码</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BE%9D%E6%AC%A1%E8%BE%93%E5%85%A5%E5%AF%86%E7%A0%81%E3%80%81%E5%9B%BD%E5%AE%B6%E3%80%81%E7%9C%81%E3%80%81%E5%B8%82%E3%80%81%E7%BB%84%E7%BB%87%E5%90%8D%E7%A7%B0%E7%AD%89"><span class="toc-text">依次输入密码、国家、省、市、组织名称等</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%94%9F%E6%88%90-server-key-pem"><span class="toc-text">生成 server-key.pem</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8A%8A%E4%B8%8B%E9%9D%A2%E7%9A%84-Host%E6%8D%A2%E6%88%90%E4%BD%A0%E8%87%AA%E5%B7%B1%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%A4%96%E7%BD%91%E7%9A%84IP%E6%88%96%E8%80%85%E5%9F%9F%E5%90%8D"><span class="toc-text">把下面的$Host换成你自己服务器外网的IP或者域名</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%99%BD%E5%90%8D%E5%8D%95"><span class="toc-text">配置白名单</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%EF%BC%8C%E5%B0%86Docker%E5%AE%88%E6%8A%A4%E7%A8%8B%E5%BA%8F%E5%AF%86%E9%92%A5%E7%9A%84%E6%89%A9%E5%B1%95%E4%BD%BF%E7%94%A8%E5%B1%9E%E6%80%A7%E8%AE%BE%E7%BD%AE%E4%B8%BA%E4%BB%85%E7%94%A8%E4%BA%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81"><span class="toc-text">执行命令，将Docker守护程序密钥的扩展使用属性设置为仅用于服务器身份验证</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%EF%BC%8C%E5%B9%B6%E8%BE%93%E5%85%A5%E4%B9%8B%E5%89%8D%E8%AE%BE%E7%BD%AE%E7%9A%84%E5%AF%86%E7%A0%81%EF%BC%8C%E7%94%9F%E6%88%90%E7%94%A8%E5%88%B0%E5%A4%B4%E7%A7%83%E7%AD%BE%E5%90%8D%E8%AF%81%E4%B9%A6"><span class="toc-text">执行命令，并输入之前设置的密码，生成用到头秃签名证书</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84key-pem%EF%BC%8C%E5%88%B0%E6%97%B6%E5%80%99%E6%8A%8A%E7%94%9F%E6%88%90%E5%A5%BD%E7%9A%84%E5%87%A0%E4%B8%AA%E5%85%AC%E9%92%A5%E7%A7%81%E9%92%A5%E6%8B%B7%E5%87%BA%E5%8E%BB%E5%8D%B3%E5%8F%AF"><span class="toc-text">生成客户端的key.pem，到时候把生成好的几个公钥私钥拷出去即可</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%EF%BC%8C%E8%A6%81%E4%BD%BF%E5%AF%86%E9%92%A5%E9%80%82%E5%90%88%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%EF%BC%8C%E8%AF%B7%E5%88%9B%E5%BB%BA%E6%89%A9%E5%B1%95%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">执行命令，要使密钥适合客户端身份验证，请创建扩展配置文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%94%9F%E6%88%90cert-pem-%E9%9C%80%E8%A6%81%E8%BE%93%E5%85%A5%E5%89%8D%E9%9D%A2%E8%AE%BE%E7%BD%AE%E7%9A%84%E5%AF%86%E7%A0%81%EF%BC%8C%E7%94%9F%E6%88%90%E7%AD%BE%E5%90%8D%E8%AF%81%E4%B9%A6"><span class="toc-text">生成cert.pem,需要输入前面设置的密码，生成签名证书</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E4%B8%8D%E9%9C%80%E8%A6%81%E7%9A%84%E6%96%87%E4%BB%B6%EF%BC%8C%E4%B8%A4%E4%B8%AA%E8%AF%81%E4%B9%A6%E7%AD%BE%E5%90%8D%E8%AF%B7%E6%B1%82"><span class="toc-text">删除不需要的文件，两个证书签名请求</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%9D%83%E9%99%90%EF%BC%8C%E8%A6%81%E4%BF%9D%E6%8A%A4%E6%82%A8%E7%9A%84%E5%AF%86%E9%92%A5%E5%85%8D%E5%8F%97%E6%84%8F%E5%A4%96%E6%8D%9F%E5%9D%8F%EF%BC%8C%E8%AF%B7%E5%88%A0%E9%99%A4%E5%85%B6%E5%86%99%E5%85%A5%E6%9D%83%E9%99%90%E3%80%82%E8%A6%81%E4%BD%BF%E5%AE%83%E4%BB%AC%E5%8F%AA%E8%83%BD%E8%A2%AB%E6%82%A8%E8%AF%BB%E5%8F%96%EF%BC%8C%E6%9B%B4%E6%94%B9%E6%96%87%E4%BB%B6%E6%A8%A1%E5%BC%8F"><span class="toc-text">修改权限，要保护您的密钥免受意外损坏，请删除其写入权限。要使它们只能被您读取，更改文件模式</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AF%81%E4%B9%A6%E5%8F%AF%E4%BB%A5%E6%98%AF%E5%AF%B9%E5%A4%96%E5%8F%AF%E8%AF%BB%E7%9A%84%EF%BC%8C%E5%88%A0%E9%99%A4%E5%86%99%E5%85%A5%E6%9D%83%E9%99%90%E4%BB%A5%E9%98%B2%E6%AD%A2%E6%84%8F%E5%A4%96%E6%8D%9F%E5%9D%8F"><span class="toc-text">证书可以是对外可读的，删除写入权限以防止意外损坏</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-docker-%E5%8F%8A-idea-%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="toc-text">3.docker 及 idea 的配置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%BD%92%E9%9B%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%81%E4%B9%A6"><span class="toc-text">归集服务器证书</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9Docker%E9%85%8D%E7%BD%AE%EF%BC%8C%E4%BD%BFDocker%E5%AE%88%E6%8A%A4%E7%A8%8B%E5%BA%8F%E4%BB%85%E6%8E%A5%E5%8F%97%E6%9D%A5%E8%87%AA%E6%8F%90%E4%BE%9BCA%E4%BF%A1%E4%BB%BB%E7%9A%84%E8%AF%81%E4%B9%A6%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E8%BF%9E%E6%8E%A5"><span class="toc-text">修改Docker配置，使Docker守护程序仅接受来自提供CA信任的证书的客户端的连接</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%A6%82%E4%B8%8B%E4%BB%A3%E7%A0%81%E5%88%B0%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%ADEnvironmentFile-etc-default-docker"><span class="toc-text">添加如下代码到配置文件中EnvironmentFile&#x3D;-&#x2F;etc&#x2F;default&#x2F;docker</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E5%8A%A0%E8%BD%BDdaemon%E5%B9%B6%E9%87%8D%E5%90%AFdocker"><span class="toc-text">重新加载daemon并重启docker</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%BC%80%E6%94%BE2375%E7%AB%AF%E5%8F%A3%EF%BC%8C%E5%88%B0qcloud%E5%AE%89%E5%85%A8%E7%BB%84%E9%87%8C%E5%8E%BB%E5%BC%80%E6%94%BE%E7%AB%AF%E5%8F%A3"><span class="toc-text">开放2375端口，到qcloud安全组里去开放端口</span></a></li></ol></li></ol></li></ol>
    <div class="back-to-top" id="back-to-top">
        <a href="javascript:void(0);">回到顶部</a>
    </div>
</div>
        <div class="post-content">
            <h4 id="1-创建ca文件夹工作目录"><a href="#1-创建ca文件夹工作目录" class="headerlink" title="1.创建ca文件夹工作目录"></a>1.创建ca文件夹工作目录</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /usr/local/ca</span><br><span class="line">cd /usr/local/ca/</span><br></pre></td></tr></table></figure>

<h4 id="2-创建-CA-私钥和公钥"><a href="#2-创建-CA-私钥和公钥" class="headerlink" title="2.创建 CA 私钥和公钥"></a>2.创建 CA 私钥和公钥</h4><h6 id="创建密码"><a href="#创建密码" class="headerlink" title="创建密码"></a>创建密码</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -aes256 -out ca-key.pem 4096</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...................++</span><br><span class="line">.................................................................................................++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">Enter pass phrase for ca-key.pem:  # 此处输入密码</span><br><span class="line">Verifying - Enter pass phrase for ca-key.pem: # 此处输入密码</span><br></pre></td></tr></table></figure>

<h6 id="依次输入密码、国家、省、市、组织名称等"><a href="#依次输入密码、国家、省、市、组织名称等" class="headerlink" title="依次输入密码、国家、省、市、组织名称等"></a>依次输入密码、国家、省、市、组织名称等</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -x509 -days 365 -key ca-key.pem -sha256 -out ca.pem</span><br></pre></td></tr></table></figure>

<h6 id="生成-server-key-pem"><a href="#生成-server-key-pem" class="headerlink" title="生成 server-key.pem"></a>生成 server-key.pem</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out server-key.pem 4096</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Generating RSA private key, 4096 bit long modulus</span><br><span class="line">...........................++</span><br><span class="line">................++</span><br><span class="line">e is 65537 (0x10001)</span><br></pre></td></tr></table></figure>

<h6 id="把下面的-Host换成你自己服务器外网的IP或者域名"><a href="#把下面的-Host换成你自己服务器外网的IP或者域名" class="headerlink" title="把下面的$Host换成你自己服务器外网的IP或者域名"></a>把下面的$Host换成你自己服务器外网的IP或者域名</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -subj &quot;/CN=www.xxx.com&quot; -sha256 -new -key server-key.pem -out server.csr</span><br></pre></td></tr></table></figure>

<h6 id="配置白名单"><a href="#配置白名单" class="headerlink" title="配置白名单"></a>配置白名单</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo subjectAltName = DNS:www.xxx.com,IP:0.0.0.0 &gt;&gt; extfile.cnf</span><br></pre></td></tr></table></figure>

<h6 id="执行命令，将Docker守护程序密钥的扩展使用属性设置为仅用于服务器身份验证"><a href="#执行命令，将Docker守护程序密钥的扩展使用属性设置为仅用于服务器身份验证" class="headerlink" title="执行命令，将Docker守护程序密钥的扩展使用属性设置为仅用于服务器身份验证"></a>执行命令，将Docker守护程序密钥的扩展使用属性设置为仅用于服务器身份验证</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo extendedKeyUsage = serverAuth &gt;&gt; extfile.cnf</span><br></pre></td></tr></table></figure>

<h6 id="执行命令，并输入之前设置的密码，生成用到头秃签名证书"><a href="#执行命令，并输入之前设置的密码，生成用到头秃签名证书" class="headerlink" title="执行命令，并输入之前设置的密码，生成用到头秃签名证书"></a>执行命令，并输入之前设置的密码，生成用到头秃签名证书</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -days 36500 -sha256 -in server.csr -CA ca.pem -CAkey ca-key.pem \-CAcreateserial -out server-cert.pem -extfile extfile.cnf</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Signature ok</span><br><span class="line">subject=/CN=x.x.x.x</span><br><span class="line">Getting CA Private Key</span><br><span class="line">Enter pass phrase for ca-key.pem: </span><br></pre></td></tr></table></figure>

<h6 id="生成客户端的key-pem，到时候把生成好的几个公钥私钥拷出去即可"><a href="#生成客户端的key-pem，到时候把生成好的几个公钥私钥拷出去即可" class="headerlink" title="生成客户端的key.pem，到时候把生成好的几个公钥私钥拷出去即可"></a>生成客户端的key.pem，到时候把生成好的几个公钥私钥拷出去即可</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out key.pem 4096</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Generating RSA private key, 4096 bit long modulus (2 primes)</span><br><span class="line">.......................................++++</span><br><span class="line">...............................................................................................................................++++</span><br><span class="line">e is 65537 (0x010001)</span><br></pre></td></tr></table></figure>

<p>执行命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -subj &#x27;/CN=client&#x27; -new -key key.pem -out client.csr</span><br></pre></td></tr></table></figure>

<h6 id="执行命令，要使密钥适合客户端身份验证，请创建扩展配置文件"><a href="#执行命令，要使密钥适合客户端身份验证，请创建扩展配置文件" class="headerlink" title="执行命令，要使密钥适合客户端身份验证，请创建扩展配置文件"></a>执行命令，要使密钥适合客户端身份验证，请创建扩展配置文件</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo extendedKeyUsage = clientAuth &gt;&gt; extfile.cnf</span><br></pre></td></tr></table></figure>

<h6 id="生成cert-pem-需要输入前面设置的密码，生成签名证书"><a href="#生成cert-pem-需要输入前面设置的密码，生成签名证书" class="headerlink" title="生成cert.pem,需要输入前面设置的密码，生成签名证书"></a>生成cert.pem,需要输入前面设置的密码，生成签名证书</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -days 365 -sha256 -in client.csr -CA ca.pem -CAkey ca-key.pem \-CAcreateserial -out cert.pem -extfile extfile.cnf</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Signature ok</span><br><span class="line">subject=CN = client</span><br><span class="line">Getting CA Private Key</span><br><span class="line">Enter pass phrase for ca-key.pem:</span><br></pre></td></tr></table></figure>

<h6 id="删除不需要的文件，两个证书签名请求"><a href="#删除不需要的文件，两个证书签名请求" class="headerlink" title="删除不需要的文件，两个证书签名请求"></a>删除不需要的文件，两个证书签名请求</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -v client.csr server.csr</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">removed &#x27;client.csr&#x27;</span><br><span class="line">removed &#x27;server.csr</span><br></pre></td></tr></table></figure>

<h6 id="修改权限，要保护您的密钥免受意外损坏，请删除其写入权限。要使它们只能被您读取，更改文件模式"><a href="#修改权限，要保护您的密钥免受意外损坏，请删除其写入权限。要使它们只能被您读取，更改文件模式" class="headerlink" title="修改权限，要保护您的密钥免受意外损坏，请删除其写入权限。要使它们只能被您读取，更改文件模式"></a>修改权限，要保护您的密钥免受意外损坏，请删除其写入权限。要使它们只能被您读取，更改文件模式</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod -v 0400 ca-key.pem key.pem server-key.pem</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mode of &#x27;ca-key.pem&#x27; changed from 0600 (rw-------) to 0400 (r--------)</span><br><span class="line">mode of &#x27;key.pem&#x27; changed from 0600 (rw-------) to 0400 (r--------)</span><br><span class="line">mode of &#x27;server-key.pem&#x27; changed from 0600 (rw-------) to 0400 (r--------)</span><br></pre></td></tr></table></figure>

<h6 id="证书可以是对外可读的，删除写入权限以防止意外损坏"><a href="#证书可以是对外可读的，删除写入权限以防止意外损坏" class="headerlink" title="证书可以是对外可读的，删除写入权限以防止意外损坏"></a>证书可以是对外可读的，删除写入权限以防止意外损坏</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod -v 0444 ca.pem server-cert.pem cert.pem</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mode of &#x27;ca.pem&#x27; changed from 0644 (rw-r--r--) to 0444 (r--r--r--)</span><br><span class="line">mode of &#x27;server-cert.pem&#x27; changed from 0644 (rw-r--r--) to 0444 (r--r--r--)</span><br><span class="line">mode of &#x27;cert.pem&#x27; changed from 0644 (rw-r--r--) to 0444 (r--r--r--)</span><br></pre></td></tr></table></figure>

<h4 id="3-docker-及-idea-的配置"><a href="#3-docker-及-idea-的配置" class="headerlink" title="3.docker 及 idea 的配置"></a>3.docker 及 idea 的配置</h4><h6 id="归集服务器证书"><a href="#归集服务器证书" class="headerlink" title="归集服务器证书"></a>归集服务器证书</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp server-*.pem  /etc/docker/</span><br><span class="line">cp ca.pem /etc/docker/</span><br></pre></td></tr></table></figure>

<h6 id="修改Docker配置，使Docker守护程序仅接受来自提供CA信任的证书的客户端的连接"><a href="#修改Docker配置，使Docker守护程序仅接受来自提供CA信任的证书的客户端的连接" class="headerlink" title="修改Docker配置，使Docker守护程序仅接受来自提供CA信任的证书的客户端的连接"></a>修改Docker配置，使Docker守护程序仅接受来自提供CA信任的证书的客户端的连接</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /lib/systemd/system/docker.service</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target docker.socket firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=docker.socket</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line"># the default is not to use systemd for cgroups because the delegate issues still</span><br><span class="line"># exists and systemd currently does not support the cgroup feature set required</span><br><span class="line"># for containers run by docker</span><br><span class="line">EnvironmentFile=-/etc/default/docker</span><br><span class="line">ExecStart=/usr/sbin/dockerd -H fd:// $DOCKER_OPTS</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">LimitNOFILE=1048576</span><br><span class="line"># Having non-zero Limit*s causes performance problems due to accounting overhead</span><br><span class="line"># in the kernel. We recommend using cgroups to do container-local accounting.</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line"># Uncomment TasksMax if your systemd version supports it.</span><br><span class="line"># Only systemd 226 and above support this version.</span><br><span class="line">TasksMax=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line"># set delegate yes so that systemd does not reset the cgroups of docker containers</span><br><span class="line">Delegate=yes</span><br><span class="line"># kill only the docker process, not all processes in the cgroup</span><br><span class="line">KillMode=process</span><br><span class="line"># restart the docker process if it exits prematurely</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<h6 id="添加如下代码到配置文件中EnvironmentFile-etc-default-docker"><a href="#添加如下代码到配置文件中EnvironmentFile-etc-default-docker" class="headerlink" title="添加如下代码到配置文件中EnvironmentFile=-/etc/default/docker"></a>添加如下代码到配置文件中EnvironmentFile=-/etc/default/docker</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DOCKER_OPTS=&quot;-H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock --tlsverify --tlscacert=/etc/docker/ca.pem --tlscert=/etc/docker/server-cert.pem --tlskey=/etc/docker/server-key.pem&quot;</span><br></pre></td></tr></table></figure>

<h6 id="重新加载daemon并重启docker"><a href="#重新加载daemon并重启docker" class="headerlink" title="重新加载daemon并重启docker"></a>重新加载daemon并重启docker</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<h6 id="开放2375端口，到qcloud安全组里去开放端口"><a href="#开放2375端口，到qcloud安全组里去开放端口" class="headerlink" title="开放2375端口，到qcloud安全组里去开放端口"></a>开放2375端口，到qcloud安全组里去开放端口</h6><p>​      </p>

        </div>
        
    </article>
</div>
<div class="paginator">
    
        
            <a class="prev" href="/2021/11/08/vue-springboot-bushu/">
                <i class="iconfont icon-prev"></i>
                <span class="nav-default">vue在springboot中部署</span>
                <span class="nav-mobile">Prev</span>
            </a>
        
        
            <a class="next" href="/2021/10/15/archlinux-i3-config-input-method/">
                <span class="nav-default">archlinux i3wm安装配置中文输入法</span>
                <span class="nav-mobile">Next</span>
                <i class="iconfont icon-next"></i>
            </a>
        
    
</div>

<div class="comment-container">
    <script src="https://utteranc.es/client.js" repo="Sneakydog-demo/sneakydog-demo.github.io" issue-term="pathname"
        theme="github-light" crossorigin="anonymous" async>
    </script>
</div>

        </div>
    </div>

    <footer class="footer-social">
    

    

    

    <div class="footer-copyright">
        <p class="time-line">
            &copy;
            
            
            2021
            &nbsp;<i class="iconfont icon-heart"></i>&nbsp;
            <a target="_blank" href="https://github.com/Hxhzfd">Hxh</a>
        </p>
        <p class="theme-info">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme -
            <a target="_blank" href="https://github.com/iJinxin/hexo-theme-sky">Sky</a>
        </p>
    </div>
</footer>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

</html>